<head>
<style>
div,button,textarea{margin:0;padding:0;box-sizing:border-box;}
</style>
</head>
<body>
<span style="display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;">„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ„ÅÇ</span>
<!--<div name="editor" style="position:relative;top:0;left:0;">-->
<!--<div name="editor" style="position:relative;margin:0;padding:0;box-sizing:border-box;">-->
<div name="editor" style="position:fixed;margin:0;padding:0;box-sizing:border-box;">
  <textarea style="position:absolute;top:0;left:0;box-sizing:border-box;width:300px;height:50vh;">alert('Hello World !!');</textarea>
  <!--
  <div name="filename" style="position:absolute;top:0;bottom:0;margin-top:auto;margin-bottom:auto;margin-left:auto;margin-right:auto;left:0;right:0;max-width:fit-content;max-width:-moz-fit-content;max-height:fit-content;max-height:-moz-fit-content;">
  -->
  <div name="file-state" style="position:absolute;top:0;margin-top:auto;margin-bottom:auto;margin-left:auto;margin-right:auto;left:0;right:0;max-width:fit-content;max-width:-moz-fit-content;max-height:fit-content;max-height:-moz-fit-content;">
    <!-- fit-sizing Chrome120‰ª•Èôç -->
    <!-- size Âêà„Çè„Å™„ÅÑ„ÄÇÂ≠óÊï∞„ÅåÂ¢ó„Åà„Çã„Åî„Å®„Å´Âæê„ÄÖ„Å´Â§ß„Åç„Åè„Å™„Å£„Å¶„ÅÑ„Åè‚Ä¶ -->
    <span name="filename" contenteditable style="display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;">some-{now}.txt</span>
    <!--
    <input name="filename" type="text" value="some-{now}.txt" minlength="1">
    <div name="filename-2" contenteditable>some-{now}.txt</div>
    <input name="filename-3" type="text" value="some-{now}.txt" style="position:absolute;">
    -->
  </div>
  <div name="menu" style="position:absolute;top:0;right:0;margin-left:auto;margin-right:auto;max-width:fit-content;max-width:-moz-fit-content;box-sizing:border-box;background-color:yellow;">
    <button>üìã</button><button>üìÑ</button>
  </div>
</div>
<script>
function onResize(entries, observer) {
    console.log('resize!!');
    const inlineSize = entries[0].contentBoxSize
        ? (entries[0].contentBoxSize[0])
            ? entries[0].contentBoxSize[0].inlineSize // ÊúÄÊñ∞
            : entries[0].contentBoxSize.inlineSize    // Âè§„ÅÑFirefox
        : entry.contentRect.width;                    // Â∞ÜÊù•ÂªÉÊ≠¢
    const blockSize = entries[0].contentBoxSize
        ? (entries[0].contentBoxSize[0])
            ? entries[0].contentBoxSize[0].blockSize // ÊúÄÊñ∞
            : entries[0].contentBoxSize.blockSize    // Âè§„ÅÑFirefox
        : entry.contentRect.height;                   // Â∞ÜÊù•ÂªÉÊ≠¢
    document.querySelector('[name="editor"]').style.inlineSize = `${inlineSize}px`;
    //document.querySelector('[name="file-state"]').style.top = `${blockSize}px`;
    const b = document.querySelector('[name="file-state"]').getBoundingClientRect();
    document.querySelector('[name="file-state"]').style.top = `${parseInt(blockSize - b.height)}px`;
    document.querySelector('[name="filename"]').style.maxWidth = `${parseInt(inlineSize)}px`;
}
const observer = new ResizeObserver(onResize);
observer.observe(document.querySelector('textarea'));
/*
function resizeTextBox(e) {
    // field-sizing: chrome 120‰ª•Èôç https://developer.mozilla.org/ja/docs/Web/CSS/field-sizing
    // size: Âæê„ÄÖ„Å´Â§ß„Åç„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÜorz
    //e.target.setAttribute('size', e.target.value.length);
    // width: Ë®àÁÆó„Åó„Å¶„Çª„ÉÉ„Éà„Åô„Çã„ÄÇ
    // https://qiita.com/jam/items/d3136d380663fd7bea6b
    const fontSize = parseFloat(getComputedStyle(e.target).getPropertyValue('font-size')); //floatÂûã„ÅÆÊï∞ÂÄ§„Å´Â§âÊèõ
    const ls = parseFloat(getComputedStyle(e.target).getPropertyValue('letter-spacing')); //floatÂûã„ÅÆÊï∞ÂÄ§„Å´Â§âÊèõ
    const width = e.target.value.length * fontSize;
    console.log(fontSize, ls);
    console.log(width);
//    e.target.setAttribute('width', `{width}px`);
    e.target.style.setProperty('width', `{width}px`)
}
document.querySelector('[name="filename"]').addEventListener('input', async(e)=>resizeTextBox(e)});
document.querySelector('[name="filename-2"]').addEventListener('input', async(e)=>resizeTextBox(e)});
*/
document.querySelector('[name="filename"]').addEventListener('input', async(e)=>{
    // field-sizing: chrome 120‰ª•Èôç https://developer.mozilla.org/ja/docs/Web/CSS/field-sizing
    // size: Âæê„ÄÖ„Å´Â§ß„Åç„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÜorz
    //e.target.setAttribute('size', e.target.value.length);
    // width: Ë®àÁÆó„Åó„Å¶„Çª„ÉÉ„Éà„Åô„Çã„ÄÇ
    // https://qiita.com/jam/items/d3136d380663fd7bea6b
    const fontSize = parseFloat(getComputedStyle(e.target).getPropertyValue('font-size')); //floatÂûã„ÅÆÊï∞ÂÄ§„Å´Â§âÊèõ
    const ls = parseFloat(getComputedStyle(e.target).getPropertyValue('letter-spacing')); //floatÂûã„ÅÆÊï∞ÂÄ§„Å´Â§âÊèõ
    console.log(fontSize, ls);
    //const width = e.target.value.length * fontSize;
    const text = e.target.value ?? e.target.textContent;
    const width = text.length * fontSize;
    console.log(width);
//    e.target.setAttribute('width', `${width}px`);
//    e.target.style.setProperty('width', `${width}px`)
//    e.target.parentElement.style.setProperty('width', `${width}px`)
//    e.target.style.setProperty('width', `${e.target.value.length}em`)
});
document.querySelector('[name="filename"]').addEventListener('keydown', async(e)=>{
    if (!e.isComposing && 'Enter'===e.key){
        e.preventDefault();
        /*
        //e.target.dispatchEvent(new KeyboardEvent('keydown', {keyCode: 40, altKey: false, shiftKey: false, key: "ArrowDown" });)
        //e.target.dispatchEvent(new KeyboardEvent('keydown', {key: 'Home', altKey: false, shiftKey: false, key: "ArrowDown" }));
        //e.target.dispatchEvent(new KeyboardEvent('keydown', {code: 0xE047, altKey: false, shiftKey: false, key: "ArrowDown" }));
        e.target.focus();
        e.target.dispatchEvent(new KeyboardEvent('keydown', {key: 'Home', altKey:false, shiftKey:false, ctrlKey:false}));
        document.querySelector('textarea').focus();
        */

        const sel = window.getSelection();
//        sel.setStart(e.target, 0);
//        sel.setEnd(e.target, 0);
//        const range = document.selection.createRange();
        const range = document.createRange();
        const offset = 5;
        //https://qiita.com/zaru/items/77ee6a7f23cca112f92d
        console.log(e.target.childNodes[0])
        console.log(e.target.firstChild)
        range.setStart(e.target.firstChild, offset);
        range.setEnd(e.target.firstChild, offset);
//        range.setStart(e.target.childNodes[0], 0);
//        range.setEnd(e.target.childNodes[0], 0);
//        range.setStart(sel.focusNode, 0);
//        range.setEnd(sel.focusNode, 1);
//        range.setStart(e.target, 0);
//        range.setEnd(e.target, 1);
//        range.collapse(true)
        sel.removeAllRanges();
        sel.addRange(range);
        console.log(range);
        document.querySelector('textarea').focus();
        /*
        */
    }
});
/*
*/

</script>
</body>
